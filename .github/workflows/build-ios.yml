name: Build & Deploy iOS App

on:
  push:
    branches:
      - main
    paths:
      - 'cTikTok/**'

jobs:
  build:
    runs-on: macos-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Get current version and increment
        id: version
        run: |
          # Read current version from source.json
          CURRENT_VERSION=$(cat backend/altstore/source.json | grep '"version"' | head -1 | sed 's/.*: *"\([^"]*\)".*/\1/')
          echo "Current version: $CURRENT_VERSION"
          
          # Increment version (1.0 -> 1.1, 1.9 -> 1.10, etc.)
          MAJOR=$(echo $CURRENT_VERSION | cut -d. -f1)
          MINOR=$(echo $CURRENT_VERSION | cut -d. -f2)
          NEW_MINOR=$((MINOR + 1))
          NEW_VERSION="${MAJOR}.${NEW_MINOR}"
          
          echo "New version: $NEW_VERSION"
          echo "version=$NEW_VERSION" >> $GITHUB_OUTPUT
          echo "build_number=$NEW_MINOR" >> $GITHUB_OUTPUT

      - name: Update Info.plist version
        run: |
          # Update CFBundleShortVersionString (display version)
          /usr/libexec/PlistBuddy -c "Set :CFBundleShortVersionString ${{ steps.version.outputs.version }}" cTikTok/cTikTok/Info.plist
          
          # Update CFBundleVersion (build number)
          /usr/libexec/PlistBuddy -c "Set :CFBundleVersion ${{ steps.version.outputs.build_number }}" cTikTok/cTikTok/Info.plist
          
          echo "Updated Info.plist:"
          /usr/libexec/PlistBuddy -c "Print :CFBundleShortVersionString" cTikTok/cTikTok/Info.plist
          /usr/libexec/PlistBuddy -c "Print :CFBundleVersion" cTikTok/cTikTok/Info.plist

      - name: Build iOS app
        run: |
          cd cTikTok
          xcodebuild -project cTikTok.xcodeproj \
              -scheme cTikTok \
              -configuration Release \
              -sdk iphoneos \
              -derivedDataPath build/DerivedData \
              CODE_SIGN_IDENTITY="-" \
              CODE_SIGNING_REQUIRED=NO \
              CODE_SIGNING_ALLOWED=NO \
              clean build

      - name: Package IPA
        run: |
          APP_PATH="cTikTok/build/DerivedData/Build/Products/Release-iphoneos/cTikTok.app"
          
          if [ ! -d "$APP_PATH" ]; then
            echo "Error: Build failed - cTikTok.app not found"
            exit 1
          fi
          
          mkdir -p build/Payload
          cp -r "$APP_PATH" build/Payload/
          cd build
          zip -r cTikTok.ipa Payload -x "*.DS_Store"
          
          echo "IPA created successfully"
          ls -la cTikTok.ipa

      - name: Update source.json
        run: |
          SIZE=$(stat -f%z build/cTikTok.ipa)
          DATE=$(date +%Y-%m-%d)
          VERSION="${{ steps.version.outputs.version }}"
          
          # Get commit message for version description (sanitize for JSON)
          DESCRIPTION=$(git log -1 --pretty=%B | head -1 | sed 's/"/\\"/g' | cut -c1-100)
          
          cat > backend/altstore/source.json << EOF
          {
            "name": "cTikTok",
            "identifier": "com.roshanc.ctiktok.source",
            "subtitle": "Share TikToks with your girlfriend",
            "sourceURL": "https://ctiktok.roshanc.com/altstore/source.json",
            "apps": [
              {
                "name": "cTikTok",
                "bundleIdentifier": "com.roshanc.ctiktok",
                "developerName": "Roshan",
                "subtitle": "Share TikToks without TikTok",
                "version": "$VERSION",
                "versionDate": "$DATE",
                "versionDescription": "$DESCRIPTION",
                "downloadURL": "https://ctiktok.roshanc.com/altstore/cTikTok.ipa",
                "localizedDescription": "A private app for sharing TikTok videos and slideshows. Features a TikTok-style vertical swipe interface, automatic video transcoding, and support for photo slideshows with audio.",
                "iconURL": "https://ctiktok.roshanc.com/altstore/icon.png",
                "tintColor": "E91E63",
                "size": $SIZE,
                "screenshotURLs": []
              }
            ],
            "news": []
          }
          EOF
          
          echo "source.json updated:"
          cat backend/altstore/source.json

      - name: Copy IPA to altstore folder
        run: |
          cp build/cTikTok.ipa backend/altstore/cTikTok.ipa
          ls -la backend/altstore/

      - name: Deploy to VPS
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          script: |
            cd ~/ctiktok
            git pull origin main
            cd backend
            docker compose down
            docker compose up -d --build
            echo "iOS app v${{ steps.version.outputs.version }} deployed!"

      - name: Upload IPA and source.json to VPS
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          source: "backend/altstore/cTikTok.ipa,backend/altstore/source.json"
          target: "~/ctiktok"
          strip_components: 0

      - name: Commit version bump
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          git add backend/altstore/source.json cTikTok/cTikTok/Info.plist
          git commit -m "Bump iOS version to ${{ steps.version.outputs.version }} [skip ci]"
          git push
